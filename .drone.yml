---
kind: pipeline
name: default
type: docker

platform:
    os: linux
    arch: amd64

steps:
    -   name: restore-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            restore: true
            cache_key: '{{ checksum "mix.exs" }}_{{ checksum "mix.lock" }}_default'
            archive_format: gzip
            mount:
                - ./deps
                - ./_build
        depends_on: [ clone ]
    -   name: compile
        image: elixir
        commands:
            - elixir -v
            - cp config/config.drone.exs config/config.secret.exs
            - mix local.hex --force
            - mix local.rebar --force
            - MIX_ENV=test mix do deps.get --only test, deps.compile, compile
        depends_on: [ restore-cache ]
    -   name: test
        image: elixir
        commands:
            - mix local.hex --force
            - mix local.rebar --force
            - mix test --color
        depends_on: [ compile ]
    -   name: rebuild-cache
        image: meltwater/drone-cache
        failure: ignore
        environment:
            AWS_ACCESS_KEY_ID:
                from_secret: aws_access_key_id
            AWS_SECRET_ACCESS_KEY:
                from_secret: aws_secret_access_key
            PLUGIN_PATH_STYLE: true
        settings:
            endpoint:
                from_secret: aws_endpoint
            region: ab-1
            bucket: drone-cache
            rebuild: true
            cache_key: '{{ checksum "mix.exs" }}_{{ checksum "mix.lock" }}_default'
            archive_format: gzip
            mount:
                - ./deps
                - ./_build
        depends_on: [ compile ]

trigger:
    branch:
        - master
        - drone

services:
    - name: ircd
      image: inspircd/inspircd-docker
      environment:
        INSP_OPER_PASSWORD_HASH: cNkbWRWn\$MhSTITMbrCxp0neoDqL66/MSI2C+oxIa4Ux6DXb5R4Q
        INSP_ENABLE_DNSBL: no
        INSP_OPER_SSLONLY: no
---
kind: signature
hmac: 7ec8317cae3c3e78ae10808c33e1242a1278c6d986ff3da3a334b5f8d0041883

...
